<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة العميل - INOVATION GROUP</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar">أ</div>
                    <div class="user-details">
                        <h3>أحمد محمد</h3>
                        <span>عميل</span>
                    </div>
                </div>
            </div>

            <ul class="sidebar-nav">
                <li><a href="#" class="active"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="#"><i class="fas fa-shipping-fast"></i> طلباتي</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> تتبع الشحنات</a></li>
                <li><a href="#"><i class="fas fa-comments"></i> المحادثات</a></li>
                <li><a href="profile-settings.html"><i class="fas fa-user-cog"></i> إعدادات الحساب</a></li>
                <li><a href="index.html" onclick="window.InovationApp.logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="dash-header">
                <h1>لوحة تحكم العميل</h1>
                <div class="user-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-bell"></i>
                        الإشعارات
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-box"></i>
                    <h3>12</h3>
                    <p>الطلبات النشطة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <h3>45</h3>
                    <p>طلبات منفذة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <h3>3</h3>
                    <p>طلبات قيد الانتظار</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star"></i>
                    <h3>4.8</h3>
                    <p>التقييم العام</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>طلب نقل جديد</h2>
                </div>
                <div class="card-body">
                    <form id="newOrderForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pickup">عنوان الاستلام</label>
                                <input type="text" id="pickup" class="form-control" placeholder="شارع التحرير، القاهرة" required>
                            </div>
                            <div class="form-group">
                                <label for="delivery">عنوان التسليم</label>
                                <input type="text" id="delivery" class="form-control" placeholder="المهندسين، الجيزة" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="shipmentType">نوع الشحنة</label>
                                <select id="shipmentType" class="form-control" required>
                                    <option value="furniture">عفش</option>
                                    <option value="documents">أوراق</option>
                                    <option value="package">طرود</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="preferredPickup">الوقت المفضل</label>
                                <input type="datetime-local" id="preferredPickup" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">ملاحظات إضافية</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="أي ملاحظات إضافية حول الشحنة..."></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                إنشاء الطلب
                            </button>
                            <button type="button" class="btn btn-outline" id="openMapBtn">
                                <i class="fas fa-map"></i>
                                فتح الخريطة
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>طلباتي الأخيرة</h2>
                </div>
                <div class="card-body">
                    <div class="orders-list" id="ordersList">
                        <!-- Orders will be loaded here dynamically -->
                    </div>
                </div>
            </div>

            <div id="chatBox" class="chat-box">
                <div class="card-header">
                    <h3>المحادثة مع المندوب</h3>
                    <button class="btn btn-outline" onclick="closeChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be loaded here -->
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" class="form-control" placeholder="اكتب رسالتك...">
                    <button class="btn btn-primary" id="sendMsg">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="assets/app.js"></script>
    <script>
        // Check if user is logged in
        const currentUser = window.InovationApp.current();
        if(!currentUser || currentUser.role !== 'customer') {
            alert('يجب تسجيل الدخول كعميل');
            window.location.href = 'login.html';
        }

        let activeOrder = null;

        // Load orders on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            updateUserInfo();
        });

        function updateUserInfo() {
            const userAvatar = document.querySelector('.user-avatar');
            const userName = document.querySelector('.user-details h3');
            
            if(currentUser) {
                userAvatar.textContent = currentUser.name.charAt(0);
                userName.textContent = currentUser.name;
            }
        }

        function loadOrders() {
            const orders = window.InovationApp.getOrdersByCustomer(currentUser.id);
            const ordersList = document.getElementById('ordersList');
            
            if(orders.length === 0) {
                ordersList.innerHTML = '<p class="muted" style="text-align: center; padding: 2rem;">لا توجد طلبات حالياً</p>';
                return;
            }

            ordersList.innerHTML = orders.map(order => `
                <div class="order-item">
                    <div class="order-info">
                        <h4>طلب #${order._id}</h4>
                        <p>من: ${order.pickup} - إلى: ${order.delivery}</p>
                        <div class="order-meta">
                            <span><i class="fas fa-clock"></i> ${window.InovationApp.formatDate(order.createdAt)}</span>
                            <span><i class="fas fa-box"></i> ${order.shipmentType}</span>
                        </div>
                    </div>
                    <div>
                        <span class="order-status ${window.InovationApp.getStatusColor(order.status)}">
                            ${window.InovationApp.getStatusText(order.status)}
                        </span>
                        ${order.assignedDriver ? `
                            <button class="btn btn-outline" style="margin-top: 0.5rem;" onclick="openChat('${order._id}')">
                                <i class="fas fa-comment"></i>
                                محادثة
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // New Order Form
        document.getElementById('newOrderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const pickup = document.getElementById('pickup').value.trim();
            const delivery = document.getElementById('delivery').value.trim();
            const shipmentType = document.getElementById('shipmentType').value;
            const preferredPickup = document.getElementById('preferredPickup').value;
            const notes = document.getElementById('notes').value.trim();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = UIHelper.showLoading(submitBtn);

            const orderData = {
                pickup,
                delivery,
                shipmentType,
                preferredPickup,
                notes
            };

            setTimeout(() => {
                const result = window.InovationApp.createOrder(orderData, currentUser.id);
                
                if(result) {
                    UIHelper.showMessage('تم إنشاء الطلب بنجاح!', 'success');
                    this.reset();
                    loadOrders();
                } else {
                    UIHelper.showMessage('حدث خطأ أثناء إنشاء الطلب');
                }
                
                UIHelper.hideLoading(submitBtn, originalText);
            }, 1500);
        });

        // Open Map
        document.getElementById('openMapBtn').addEventListener('click', function() {
            const pickup = document.getElementById('pickup').value;
            const delivery = document.getElementById('delivery').value;
            
            if(pickup || delivery) {
                const address = pickup || delivery;
                const url = `https://www.google.com/maps/search/${encodeURIComponent(address)}`;
                window.open(url, '_blank');
            } else {
                alert('يرجى إدخال عنوان أولاً');
            }
        });

        // Chat Functions
        function openChat(orderId) {
            activeOrder = orderId;
            document.getElementById('chatBox').style.display = 'block';
            loadChatMessages();
        }

        function closeChat() {
            activeOrder = null;
            document.getElementById('chatBox').style.display = 'none';
        }

        function loadChatMessages() {
            if(!activeOrder) return;
            
            const messages = window.InovationApp.getChat(activeOrder);
            const chatMessages = document.getElementById('chatMessages');
            
            if(messages.length === 0) {
                chatMessages.innerHTML = '<p class="muted" style="text-align: center; padding: 2rem;">لا توجد رسائل بعد</p>';
                return;
            }

            chatMessages.innerHTML = messages.map(msg => `
                <div class="message ${msg.senderId === currentUser.id ? 'sent' : 'received'}">
                    <strong>${msg.senderId === currentUser.id ? 'أنت' : 'المندوب'}:</strong> ${msg.text}
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">
                        ${new Date(msg.timestamp).toLocaleTimeString('ar-EG')}
                    </div>
                </div>
            `).join('');
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.getElementById('sendMsg').addEventListener('click', function() {
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value.trim();
            
            if(!text || !activeOrder) return;
            
            window.InovationApp.addMessage(activeOrder, currentUser.id, text);
            chatInput.value = '';
            loadChatMessages();
        });

        // Auto refresh orders every 30 seconds
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>